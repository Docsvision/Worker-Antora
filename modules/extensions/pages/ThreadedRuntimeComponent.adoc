= Компонент

_Компонент_ – расширения Службы не имеющее определенного назначения: программист может реализовать любую функциональность, которая может быть запущена и по запросу остановлена.

Класс расширения _Компонент_ должен реализовывать два интерфейса: `IThreadedRuntimeComponent` и `ISettings`.

[source,csharp]
----
public class ComponentExt : IThreadedRuntimeComponent, ISettings

----

Описание данных интерфейсов приведено в пункте xref:ObjectTypes.adoc[Типы объектов].

В общем случае класс расширения должен содержать:

* методы:
* `Start` – должен содержать реализацию требуемой функциональности расширения (например, обрабатывать карточки Docsvision). Данная функция будет вызвана один раз при запуске (перезапуске) РП;
* `Stop` – должен останавливать реализованную функциональность расширения;
* поля:
* `Stopped` – должен вернуть true, если компонент остановлен (был вызван `Stop` или не был вызван `Start`);
* `Data` – будет сохранена строка с настройками, указанная в конфигурации Службы для данного расширения.

*Обратите внимание*: после вызова метода `IThreadedRuntimeComponent.Stop` значение `Stopped` должно быть изменено на TRUE (после фактического завершения работы функций _Компонента_) – РП не завершит свою работу, если хотя бы у одного из его _Компонентов_ `Stopped` в значении FALSE.

Если для выполнения функций _Компонента_ нужен доступ к xref:Services.adoc[сервисам API Службы], в классе расширения нужно реализовать интерфейс `IInitializeWithServiceProvider`. См. xref:GetServiceProvider.adoc[Получение поставщика сервисов в расширении].

== Базовый класс ThreadedRuntimeComponent

При разработке _Компонента_, в котором определенную функцию нужно выполнять в цикле, можно воспользоваться готовой реализацией интерфейса `IThreadedRuntimeComponent` – класс `Docsvision.WorkerService.Runtime.ThreadedRuntimeComponent` (сборка `Docsvision.WorkerService.Runtime.dll`):

[source,csharp]
----
public abstract class ThreadedRuntimeComponent : InitializeWithServiceProvider, IThreadedRuntimeComponent
----

При создании класса на основе `ThreadedRuntimeComponent` нужно:

. Добавить реализацию интерфейса `ISettings`.

. Переопределить абстрактный метод `DoWork`, в котором нужно реализовать функциональность _Компонента_.

Метод `DoWork` вызывается в цикле до получения сигнала остановки (вызов метода `Stop`) или до остановки по инициативе метода (см. ниже).

Метод `DoWork` должен вернуть TRUE для продолжения работы _Компонента_, или FALSE – для завершения работы. Во втором случае будет вызван метод `Shutdown` (может быть переопределен), вызваны события `GetShutdownSignals` (может быть переопределен), `IThreadedRuntimeComponent.Stopped` установлен в TRUE.

. Если нужно, изменить время ожидания до запуска следующего цикла (по умолчанию 60 секунд). Для этого переопределите метод `GetWorkPeriod`: должен возвращать требуемое время ожидания в миллисекундах.

== Примеры реализации Компонента

Следующий код демонстрирует пример _Компонента_, в котором при запуске и остановке записывается сообщение в файл `comp.log`.

[source,csharp]
----
public class BestComponent : IThreadedRuntimeComponent, ISettings
{
    public bool Stopped { get; private set; }
    public string Data { get; set; } // В Data передаются настройки Компонента из конфигурации

    // Вызывается при запуске Компонента (при запуске РП)
    public void Start()
    {
        Stopped = false; // Нужно указать, что компонент не остановлен (запущен)
        System.IO.File.AppendAllText(@"C:\logs\comp.log", $"Запущен с настройками: {Data}\n");   
    }
    
    // Вызывается при остановке Компонента (при остановке РП)
    public void Stop()
    {
        Stopped = true; // Нужно указать, что компонент остановлен
        System.IO.File.AppendAllText(@"C:\logs\comp.log", $"Остановлен\n");
    }
}
----

== Подключение расширения к Службе

Все следующие действия выполняются на сервере Службы.

. xref:ExtensionRegistration.adoc[Зарегистрируйте разработанное расширения на сервере Службы].

. Добавьте расширение `SomeComponent` в конфигурацию Службы:

. Создайте раздел `HKLM\SOFTWARE\DocsVision\WorkerService\5.5\Components\SomeComponent` («SomeComponent» – выбрано произвольно) в реестре ОС.

. В созданном разделе:

.. Укажите полное имя класса `SomeComponent` в параметре по умолчанию.
.. Создайте строковый параметр «ComponentSetting» (выбрано произвольно) со значением, например, «Настройки Компонента» – строка настроек, которая будет передаваться в `ISettings.Data`.
. Создайте `Роль рабочего процесса`, через которую РП будет получать расширение `BestComponent`:

. Создайте раздел `HKLM\SOFTWARE\DocsVision\WorkerService\5.5\Roles\RoleWithBestComponent` («RoleWithBestComponent» – выбрано произвольно) в реестре ОС.

. В созданном разделе создайте строковый параметр «Components» со значением «ComponentSetting» – название строки с параметрами расширения `BestComponent`, которая была создана на шаге 2.2.2.

image:img/componentRoleRegistry.png[]

. Зарегистрируйте экземпляр РП с _Ролью_ «RoleWithBestComponent».

. Создайте раздел `HKLM\SOFTWARE\DocsVision\WorkerService\5.5\Roles\SOFTWARE\DocsVision\WorkerService\5.5\WorkerProcesses\WpBestComponent` («WpBestComponent» – выбрано произвольно) в реестре ОС.

. В созданном разделе создайте параметры:
** «Architecture» с типом DWORD и значением «1» (архитектура – x86);
** «Disabled» с типом DWORD и значением «0»;
** «Roles» со строковым типом и значением «RoleWithBestComponent».

image:img/componentWpRegistry.png[]

== Проверка примера

. Создайте папку `C:\logs\` и предоставьте полные права на данную папку учетной записи службы «WorkerService».

. Перезапустите службу «WorkerService».

В папке `C:\logs\` будет создан файл `comp.log`, содержащий текст «Запущен с настройками: Настройки Компонента».

. Остановите службу «WorkerService».

В файл `C:\logs\comp.log` будет добавлена строка «Остановлен»